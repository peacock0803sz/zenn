---
title: "Pyramidã§ã®CORSã¨Preflight request"
emoji: "ğŸ"
type: "tech"
topics:
  - "python"
  - "cors"
  - "pyramid"
published: true
published_at: "2021-11-08 11:32"
---

# CORSã¨Preflight request

ä»•äº‹ã§CORSã¨Preflight requestã«ã¤ã„ã¦ãƒãƒã£ãŸã®ã§å‚™å¿˜éŒ²çš„ã«æ›¸ã„ã¦ãŠãã¾ã™

## Code

@[gist](https://gist.github.com/mmerickel/1afaf64154b335b596e4)

## Access-Control-Allow-Origin

- Responseã®ä¸­ã«`Access-Control-Allow-Origin`ã‚’ã¤ã‘ã‚‹ã¨ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆçš„ã«HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã§ãã‚‹
    - <https://developer.mozilla.org/ja/docs/Web/HTTP/CORS#cors_ã‚’ä½¿ç”¨ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã¯>

ä¾‹: Pyramidã§localhostã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹å ´åˆã€`event.response.headers[["Access-Control-Allow-Origin"]]`ã«Originã‚’æ›¸ã
```python
def add_cors_to_response(event):
    response = event.response
    response.headers[
        "Access-Control-Expose-Headers"
    ] = "Content-Type,Date,Content-Length,Authorization,X-Request-ID"
    response.headers["Access-Control-Allow-Origin"] = "http://localhost"
    response.headers["Access-Control-Allow-Credentials"] = "true"
```

## Preflight request

- [Preflight request](https://developer.mozilla.org/ja/docs/Glossary/Preflight_request) = æœ¬ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‰ã«é€ã‚‹ã€MethodãŒ`OPTIONS`ãªHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    - [å˜ç´”ãƒªã‚¯ã‚¨ã‚¹ãƒˆ](https://developer.mozilla.org/ja/docs/Web/HTTP/CORS#å˜ç´”ãƒªã‚¯ã‚¨ã‚¹ãƒˆ)ä»¥å¤–ã®æ™‚ã«é€ã‚‰ã‚Œã‚‹
        - `<a>, <form>`ã¨ã‹ã§ã¯ãªãã€XMLHttpRequestã‚„Fetch APIã®ã‚ˆã†ãªJSã‹ã‚‰åˆ©ç”¨ã§ãã‚‹ã‚‚ã®
- ã“ã®å¾Œã®æœ¬ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§`Access-Control-Allow-Headers`ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¨±å¯ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ãŒã‚ã‚‹ã¨CORS policyã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹

ä¾‹: Pyramidã§ä»»æ„ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨±å¯ã™ã‚‹
```python
def add_cors_preflight_handler(config):
    config.add_route(
        "cors-options-preflight",
        "/{catch_all:.*}",
        cors_preflight=True,
    )
    config.add_view(
        cors_options_view,
        route_name="cors-options-preflight",
        permission=NO_PERMISSION_REQUIRED,
    )


def cors_options_view(context, request):
    response = request.response
    if "Access-Control-Request-Headers" in request.headers:
        response.headers[
            "Access-Control-Allow-Methods"
        ] = "OPTIONS,HEAD,GET,POST,PUT,DELETE"
    response.headers[
        "Access-Control-Allow-Headers"
    ] = "Content-Type,Accept,Accept-Language,Authorization,X-Request-ID"  # ã“ã“ã«è¿½åŠ ã™ã‚‹
    return response
```